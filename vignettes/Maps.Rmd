---
title: "Map Functions"
author: "Gregory Green"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8} 
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-"
)

```

## Traffic Fatality Analysis

Traffic fatalities are recorded by the US National Highway Traffic Safety Administration's Fatality Analysis Reporting System (NHTSA). This package extracts data for the years 2013, 2014, and 2015. The fatalities can be summarized in one of two ways, a table for each month of each year or in a map of a specific state.

The function fars_summarize_years uses the traffic fatality data set across all states and summarizes the data in that set.

```{r summarise}
fars_summarize_years <- function(years) {
        dat_list <- fars_read_years(years)
        print(dat_list)
        dplyr::bind_rows(dat_list) %>% 
                dplyr::group_by(year, MONTH) %>% 
                dplyr::summarize(n = n()) %>%
                tidyr::spread(year, n)
}
```

The function fars_map_state() uses the data from the NSTSA and plots a year's traffic fatalities in a map of the state where the fatalities occurred, if there were traffic fatalities in that state for that year.

```{r map}
fars_map_state <- function(state.num, year) {
        filename <- make_filename(year)
        data <- fars_read(filename)
        state.num <- as.integer(state.num)

        if(!(state.num %in% unique(data$STATE)))
                stop("invalid STATE number: ", state.num)
        data.sub <- dplyr::filter(data, STATE == state.num)
        if(nrow(data.sub) == 0L) {
                message("no accidents to plot")
                return(invisible(NULL))
        }
        is.na(data.sub$LONGITUD) <- data.sub$LONGITUD > 900
        is.na(data.sub$LATITUDE) <- data.sub$LATITUDE > 90
        with(data.sub, {
                maps::map("state", ylim = range(LATITUDE, na.rm = TRUE),
                          xlim = range(LONGITUD, na.rm = TRUE))
                graphics::points(LONGITUD, LATITUDE, pch = 46)
        })
}
```
